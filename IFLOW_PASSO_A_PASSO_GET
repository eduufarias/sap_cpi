# iFlow CPI - Consulta LFA1 (Business Partners)

## ğŸ¯ Objetivo
Criar um iFlow no SAP CPI que consome sua API REST ABAP e disponibiliza para teste no Postman

---

## ğŸ“‹ Sua API ABAP Atual

```
Endpoint SAP: http://vhnoaqs4ci:8000/sap/bc/ui2/consultalfa1
MÃ©todo: GET
ParÃ¢metros: ?lifnr=0001000001 (opcional)
```

---

## ğŸ”§ PASSO 1: Criar Integration Flow no CPI

### No SAP Integration Suite:

1. **Design** â†’ **Integrations**
2. Clique em **Create**
3. Preencha:
   ```
   Name: Consulta LFA1 Business Partners
   ID: ConsultaLFA1_BP
   Package: [Seu package]
   ```
4. Clique em **OK**

---

## ğŸ”Œ PASSO 2: Configurar HTTP Sender (Entrada do CPI)

### ConfiguraÃ§Ã£o:

1. Clique no **Sender** â†’ Arraste atÃ© **Start**
2. Selecione **HTTP**

**Aba Connection:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Address: /consulta-bp                  â”‚
â”‚ Method: GET                            â”‚
â”‚ Authentication: Basic                  â”‚
â”‚ User Role: ESBMessaging.send           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Aba Processing:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Parameters: Pass Through         â”‚
â”‚ Request Headers: *                     â”‚
â”‚ Response Headers: *                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ PASSO 3: Content Modifier 1 - Preparar Request

### ConfiguraÃ§Ã£o:

**Message Header:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name: Accept                           â”‚
â”‚ Value: application/json                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Name: Content-Type                     â”‚
â”‚ Value: application/json                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Exchange Property:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name: lifnr                            â”‚
â”‚ Type: Expression                       â”‚
â”‚ Value: ${header.lifnr}                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ PASSO 4: Request Reply - Chamar API ABAP

### ConfiguraÃ§Ã£o do HTTP Receiver:

**Aba Connection:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Address:                                                     â”‚
â”‚ http://vhnoaqs4ci:8000/sap/bc/ui2/consultalfa1              â”‚
â”‚                                                              â”‚
â”‚ Query: ${property.lifnr}                                     â”‚
â”‚                                                              â”‚
â”‚ Proxy Type: Internet                                         â”‚
â”‚ Method: GET                                                  â”‚
â”‚ Authentication: Basic                                        â”‚
â”‚ Credential Name: SAP_ABAP_CREDENTIALS                        â”‚
â”‚ Timeout (in ms): 30000                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**IMPORTANTE:** Se o parÃ¢metro lifnr vier na URL, use:
```
Address: http://vhnoaqs4ci:8000/sap/bc/ui2/consultalfa1?lifnr=${property.lifnr}
```

**Aba Processing:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request Headers: Accept,Content-Type   â”‚
â”‚ Response Headers: *                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» PASSO 5: Groovy Script - Processar Response

### Script:

```groovy
import com.sap.gateway.ip.core.customdev.util.Message
import groovy.json.JsonSlurper
import groovy.json.JsonOutput

def Message processData(Message message) {
    
    // Obter o corpo da mensagem (JSON do SAP)
    def body = message.getBody(String.class)
    def jsonSlurper = new JsonSlurper()
    def sapResponse = jsonSlurper.parseText(body)
    
    // Processar os dados dos fornecedores
    def fornecedores = sapResponse.collect { item ->
        [
            codigoFornecedor: item.lifnr?.trim() ?: "",
            nome: item.name1?.trim() ?: "",
            cidade: item.ort01?.trim() ?: "",
            regiao: item.regio?.trim() ?: "",
            pais: item.land1?.trim() ?: ""
        ]
    }
    
    // Criar resposta formatada
    def output = [
        status: "success",
        timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'"),
        totalRegistros: fornecedores.size(),
        fornecedores: fornecedores
    ]
    
    message.setBody(JsonOutput.toJson(output))
    message.setHeader("Content-Type", "application/json")
    
    return message
}
```

---

## ğŸ“ PASSO 6: Content Modifier 2 - Formatar Response

### ConfiguraÃ§Ã£o:

**Message Header:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name: Content-Type                     â”‚
â”‚ Value: application/json                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Name: CamelHttpResponseCode            â”‚
â”‚ Value: 200                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ PASSO 7: Exception Subprocess

### Content Modifier (Exception):

**Message Body:**
```json
{
  "status": "error",
  "message": "${exception.message}",
  "timestamp": "${date:now:yyyy-MM-dd'T'HH:mm:ss'Z'}",
  "endpoint": "http://vhnoaqs4ci:8000/sap/bc/ui2/consultalfa1"
}
```

**Message Header:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name: CamelHttpResponseCode            â”‚
â”‚ Value: 500                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” PASSO 8: Criar Credenciais SAP ABAP

### No CPI:

1. **Monitor** â†’ **Security Material**
2. **Create** â†’ **User Credentials**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name: SAP_ABAP_CREDENTIALS             â”‚
â”‚ User: seu_usuario_sap                  â”‚
â”‚ Password: sua_senha_sap                â”‚
â”‚ Description: Credenciais SAP ABAP      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

3. Clique em **Deploy**

---

## ğŸš€ PASSO 9: Deploy do iFlow

1. **Save** (ğŸ’¾)
2. **Deploy** (ğŸš€)
3. Aguarde status **Started** (âœ…)

---

## ğŸ§ª PASSO 10: Testar no Postman

### Obter Endpoint CPI:

```
https://seu-tenant.it-cpi.cfapps.eu10.hana.ondemand.com/http/consulta-bp
```

### Teste 1: Buscar 10 Fornecedores (sem parÃ¢metro)

```http
GET https://seu-tenant.it-cpi.cfapps.eu10.hana.ondemand.com/http/consulta-bp
Authorization: Basic base64(user:password)
```

**Response Esperada:**
```json
{
  "status": "success",
  "timestamp": "2024-11-18T10:30:00Z",
  "totalRegistros": 10,
  "fornecedores": [
    {
      "codigoFornecedor": "0001000001",
      "nome": "Fornecedor Teste",
      "cidade": "SÃ£o Paulo",
      "regiao": "SP",
      "pais": "BR"
    }
  ]
}
```

### Teste 2: Buscar Fornecedor EspecÃ­fico

```http
GET https://seu-tenant.it-cpi.cfapps.eu10.hana.ondemand.com/http/consulta-bp?lifnr=0001000001
Authorization: Basic base64(user:password)
```

**Response Esperada:**
```json
{
  "status": "success",
  "timestamp": "2024-11-18T10:30:00Z",
  "totalRegistros": 1,
  "fornecedores": [
    {
      "codigoFornecedor": "0001000001",
      "nome": "Fornecedor EspecÃ­fico",
      "cidade": "Rio de Janeiro",
      "regiao": "RJ",
      "pais": "BR"
    }
  ]
}
```

---

## ğŸ“Š Diagrama do Fluxo Completo

```
POSTMAN
   â”‚
   â”‚ GET /http/consulta-bp?lifnr=0001000001
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SAP CPI iFlow                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Sender  â”‚â”€â”€>â”‚ Start â”‚â”€â”€>â”‚  Content    â”‚                â”‚
â”‚  â”‚  HTTP   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ Modifier 1  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                   â”‚                         â”‚
â”‚                                   â–¼                         â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                            â”‚  Request    â”‚                 â”‚
â”‚                            â”‚   Reply     â”‚                 â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                   â”‚                         â”‚
â”‚                                   â–¼                         â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                            â”‚   Receiver   â”‚                â”‚
â”‚                            â”‚  (SAP ABAP)  â”‚                â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                   â”‚                         â”‚
â”‚                                   â–¼                         â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                            â”‚   Groovy    â”‚                 â”‚
â”‚                            â”‚   Script    â”‚                 â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                   â”‚                         â”‚
â”‚                                   â–¼                         â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                            â”‚  Content    â”‚â”€â”€>â”‚  End  â”‚     â”‚
â”‚                            â”‚ Modifier 2  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”‚ Response JSON
   â”‚
   â–¼
POSTMAN
```

---

## ğŸ”— Fluxo de Dados Detalhado

```
1. POSTMAN envia:
   GET /http/consulta-bp?lifnr=0001000001

2. CPI recebe e extrai parÃ¢metro:
   lifnr = 0001000001

3. CPI chama SAP ABAP:
   GET http://vhnoaqs4ci:8000/sap/bc/ui2/consultalfa1?lifnr=0001000001

4. SAP ABAP retorna:
   [
     {
       "lifnr": "0001000001",
       "name1": "Fornecedor Teste",
       "ort01": "SÃ£o Paulo",
       "regio": "SP",
       "land1": "BR"
     }
   ]

5. Groovy processa e formata:
   {
     "status": "success",
     "timestamp": "2024-11-18T10:30:00Z",
     "totalRegistros": 1,
     "fornecedores": [...]
   }

6. CPI retorna para POSTMAN:
   HTTP 200 OK
   Content-Type: application/json
   {...}
```

---

## ğŸ“¦ Collection Postman

Importe esta collection:

```json
{
  "info": {
    "name": "SAP CPI - Consulta LFA1",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Buscar 10 Fornecedores",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{cpi_endpoint}}/http/consulta-bp",
          "host": ["{{cpi_endpoint}}"],
          "path": ["http", "consulta-bp"]
        }
      }
    },
    {
      "name": "Buscar Fornecedor por CÃ³digo",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{cpi_endpoint}}/http/consulta-bp?lifnr=0001000001",
          "host": ["{{cpi_endpoint}}"],
          "path": ["http", "consulta-bp"],
          "query": [
            {
              "key": "lifnr",
              "value": "0001000001"
            }
          ]
        }
      }
    }
  ],
  "auth": {
    "type": "basic",
    "basic": [
      {
        "key": "username",
        "value": "{{cpi_user}}",
        "type": "string"
      },
      {
        "key": "password",
        "value": "{{cpi_password}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "cpi_endpoint",
      "value": "https://seu-tenant.it-cpi.cfapps.eu10.hana.ondemand.com",
      "type": "string"
    },
    {
      "key": "cpi_user",
      "value": "seu_usuario",
      "type": "string"
    },
    {
      "key": "cpi_password",
      "value": "sua_senha",
      "type": "string"
    }
  ]
}
```

---

## âœ… Checklist

- [ ] iFlow criado no CPI
- [ ] HTTP Sender configurado com `/consulta-bp`
- [ ] Content Modifier 1 preparando headers
- [ ] Request Reply apontando para `http://vhnoaqs4ci:8000/sap/bc/ui2/consultalfa1`
- [ ] Credenciais `SAP_ABAP_CREDENTIALS` criadas
- [ ] Groovy Script processando response
- [ ] Content Modifier 2 formatando response
- [ ] Exception Subprocess configurado
- [ ] iFlow deployado com sucesso
- [ ] Testado no Postman

---

## ğŸ› Troubleshooting

### Erro: Connection Refused
- Verifique se o servidor SAP estÃ¡ acessÃ­vel do CPI
- Teste: `telnet vhnoaqs4ci 8000`

### Erro: 401 Unauthorized
- Verifique as credenciais `SAP_ABAP_CREDENTIALS`
- Teste direto no navegador: `http://vhnoaqs4ci:8000/sap/bc/ui2/consultalfa1`

### Erro: Timeout
- Aumente o timeout no HTTP Receiver para 60000ms
- Verifique performance da query no SAP

### Dados nÃ£o retornam
- Verifique se existem dados na LFA1
- Teste a API ABAP diretamente
- Ative o Trace no iFlow

Pronto! Seu iFlow estÃ¡ configurado para consumir a API ABAP e disponibilizar no Postman! ğŸš€
